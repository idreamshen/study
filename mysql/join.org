* 创建一个 Mysql Server
#+begin_src sh
  docker run -d --name mysql_test -p3306:3306 -eMYSQL_ALLOW_EMPTY_PASSWORD=true mysql:5.7
#+end_src

#+RESULTS:
: 98fec8c7a206ab0ab79b3bf91200d44083e3a373ee6bf1164e5040a21d2085f8

* 初始化数据结构
#+begin_src sql :engine mysql :dbhost 127.0.0.1 :dbuser root :exports both
drop database if exists join_test_db;
create database if not exists join_test_db;
show databases;
#+end_src

#+RESULTS:
| Database           |
|--------------------|
| information_schema |
| join_test_db       |
| mysql              |
| performance_schema |
| sys                |

* 建表
#+begin_src sql :engine mysql :database join_test_db :dbhost 127.0.0.1 :dbuser root :exports both
  create table if not exists game_match (
      `id` bigint auto_increment,
      `name` varchar(64) not null default '',
      primary key (`id`)
  ) engine=innodb default charset=utf8 comment '比赛';

  create table if not exists game_match_player (
      `id` bigint auto_increment,
      `match_id` bigint not null default 0,
      `nickname` varchar(255) not null default '',
      primary key (`id`),
      index idx_match_id (`match_id`)
  ) engine=innodb default charset=utf8 comment '比赛玩家';

  show tables;
#+end_src

#+RESULTS:
| Tables_in_join_test_db |
|------------------------|
| game_match             |
| game_match_player      |

* 初始化数据
#+begin_src sql :engine mysql :database join_test_db :dbhost 127.0.0.1 :dbuser root :exports both
  truncate table game_match;
  truncate table game_match_player;

  delimiter $
  drop procedure batch_insert_game_match;
  create procedure batch_insert_game_match()
  begin
      declare i int default 1;
      while i <= 100 do
          insert into game_match (id, `name`) values (i, concat("match-", i));
          set i = i + 1;
       end while;
  end $

  delimiter $$
  drop procedure batch_insert_game_match_player;
  create procedure batch_insert_game_match_player()
  begin
      declare i int default 1;
      while i <= 1000 do
          insert into game_match_player (id, `match_id`, `nickname`) values (i, floor((i - 1) / 10) +1, concat("player-", i));
          set i = i + 1;
       end while;
  end $$

  call batch_insert_game_match();
  call batch_insert_game_match_player();
  select * from game_match limit 5;
  select * from game_match_player limit 20;
#+end_src

#+RESULTS:
| id |     name |           |
|----+----------+-----------|
|  1 |  match-1 |           |
|  2 |  match-2 |           |
|  3 |  match-3 |           |
|  4 |  match-4 |           |
|  5 |  match-5 |           |
| id | match_id | nickname  |
|  1 |        1 | player-1  |
|  2 |        1 | player-2  |
|  3 |        1 | player-3  |
|  4 |        1 | player-4  |
|  5 |        1 | player-5  |
|  6 |        1 | player-6  |
|  7 |        1 | player-7  |
|  8 |        1 | player-8  |
|  9 |        1 | player-9  |
| 10 |        1 | player-10 |
| 11 |        2 | player-11 |
| 12 |        2 | player-12 |
| 13 |        2 | player-13 |
| 14 |        2 | player-14 |
| 15 |        2 | player-15 |
| 16 |        2 | player-16 |
| 17 |        2 | player-17 |
| 18 |        2 | player-18 |
| 19 |        2 | player-19 |
| 20 |        2 | player-20 |

* JOIN 效果测试
** 驱动表为小表时的 explain
#+begin_src sql :engine mysql :database join_test_db :dbhost 127.0.0.1 :dbuser root :exports both
explain
select count(*) from game_match gm
left join game_match_player gmp
on gm.id = gmp.match_id;
#+end_src

#+RESULTS:
| id | select_type | table | partitions | type  | possible_keys | key          | key_len | ref                | rows | filtered | Extra       |
|----+-------------+-------+------------+-------+---------------+--------------+---------+--------------------+------+----------+-------------|
|  1 | SIMPLE      | gm    | NULL       | index | NULL          | PRIMARY      |       8 | NULL               |  100 |   100.00 | Using index |
|  1 | SIMPLE      | gmp   | NULL       | ref   | idx_match_id  | idx_match_id |       8 | join_test_db.gm.id |   10 |   100.00 | Using index |


** 驱动表为大表时的 explain
#+begin_src sql :engine mysql :database join_test_db :dbhost 127.0.0.1 :dbuser root :exports both
explain
select count(*) from game_match_player gmp
left join game_match gm
on gm.id = gmp.match_id;
#+end_src

#+RESULTS:
| id | select_type | table | partitions | type   | possible_keys | key          | key_len | ref                       | rows | filtered | Extra       |
|----+-------------+-------+------------+--------+---------------+--------------+---------+---------------------------+------+----------+-------------|
|  1 | SIMPLE      | gmp   | NULL       | index  | NULL          | idx_match_id |       8 | NULL                      | 1000 |   100.00 | Using index |
|  1 | SIMPLE      | gm    | NULL       | eq_ref | PRIMARY       | PRIMARY      |       8 | join_test_db.gmp.match_id |    1 |   100.00 | Using index |

** 性能对比
#+begin_src sql :engine mysql :database join_test_db :dbhost 127.0.0.1 :dbuser root :exports both
  set profiling=1;

  -- 驱动表小表
  select count(*) from game_match gm
  left join game_match_player gmp
  on gm.id = gmp.match_id;

  -- 驱动表为大表
  select count(*) from game_match_player gmp
  left join game_match gm
  on gm.id = gmp.match_id;

  set profiling=0;
  show profiles;
#+end_src

#+RESULTS:
| count(*) |            |                                                                                              |
|----------+------------+----------------------------------------------------------------------------------------------|
|     1000 |            |                                                                                              |
| count(*) |            |                                                                                              |
|     1000 |            |                                                                                              |
| Query_ID |   Duration | Query                                                                                        |
|        1 | 0.00081900 | select count(*) from game_match gm\nleft join game_match_player gmp\non gm.id = gmp.match_id |
|        2 | 0.00101050 | select count(*) from game_match_player gmp\nleft join game_match gm\non gm.id = gmp.match_id |
可以发现 SQL2 的耗时几乎是 SQL1 的两倍

* 参考资料
- [[https://emacs.stackexchange.com/questions/48835/help-me-avoid-true-in-org-babel-bash-statements][Help me avoid “|| true” in org babel bash statements]]
